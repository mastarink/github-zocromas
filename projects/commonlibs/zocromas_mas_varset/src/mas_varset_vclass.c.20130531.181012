#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>

#include <search.h>

#include <mastar/wrap/mas_std_def.h>

#include <mastar/wrap/mas_memory.h>
#include <mastar/wrap/mas_lib0.h>
#include <mastar/wrap/mas_lib.h>
#include <mastar/tools/mas_tools.h>
#include <mastar/tools/mas_arg_tools.h>

#include <mastar/types/mas_varset_types.h>
#include "mas_varset_vclass.h"



#if 1
static const char *final_str = "\r\n";
static size_t final_len = 2;

#  define MAS_FINAL_STR (char*)final_str
#  define MAS_FINAL_LEN final_len
#else
#  define MAS_FINAL_STR NULL
#  define MAS_FINAL_LEN 0
#endif

static const char *tail_str = "\r\n";
static size_t tail_len = 2;

#define MAS_TAIL_STR tail_str
#define MAS_TAIL_LEN tail_len



mas_varset_class_t *
mas_varset_vclass_create( const char *vclass_name )
{
  mas_varset_class_t *vclass = NULL;

  vclass = mas_malloc( sizeof( mas_varset_class_t ) );
  if ( vclass )
  {
    memset( vclass, 0, sizeof( mas_varset_class_t ) );
    if ( vclass_name )
      vclass->name = mas_strdup( vclass_name );
    vclass->has_head = 1;
  }
  return vclass;
}

void
mas_varset_vclass_delete( mas_varset_class_t * vclass )
{
  if ( vclass )
  {
    if ( vclass->veccnt && vclass->vec )
    {
      mas_var_t *vec;

      vec = vclass->vec;
      for ( int i = 0; i < vclass->veccnt * 2 + vclass->has_head; i++ )
      {
        char *v;

        v = vec[i].iov_base;
        vec[i].iov_base = NULL;
        if ( v )
        {
          mas_free( v );
        }
      }
      if ( vec )
      {
        mas_free( vclass->vec );
      }
    }
    if ( vclass->name )
    {
      mas_free( vclass->name );
      vclass->name = NULL;
    }
    mas_free( vclass );
    vclass = NULL;
  }
}

const char *
mas_varset_vclass_name( mas_varset_class_t * vclass )
{
  return vclass ? vclass->name : NULL;
}

unsigned long
mas_varset_vclass_id( mas_varset_class_t * vclass )
{
  return vclass ? vclass->id : 0;
}

static int
mas_varset_compare_vclass( const void *a, const void *b )
{
  mas_varset_class_t *aclass, *bclass;

  aclass = ( mas_varset_class_t * ) a;
  bclass = ( mas_varset_class_t * ) b;
  if ( a == b )
    return 0;
  if ( !aclass->name )
    return bclass->name ? -1 : 0;
  if ( !bclass->name )
    return aclass->name ? 1 : 0;
  return strcmp( aclass->name, bclass->name );
}

mas_varset_class_t *
mas_varset_search_vclass( mas_varset_t * varset, const char *vclass_name )
{
  mas_varset_class_t *vclass = NULL;
  mas_varset_class_t *found = NULL;

  if ( varset )
  {
    mas_varset_class_t **pfound = NULL;

    vclass = mas_varset_vclass_create( vclass_name );
    if ( vclass )
    {
      pfound = tsearch( vclass, &varset->classes, mas_varset_compare_vclass );
      if ( pfound )
        found = *pfound;
      if ( found == vclass )
      {
        found->id = ++varset->nclasses;
      }
      else
      {
        mas_varset_vclass_delete( vclass );
        vclass = NULL;
      }
    }
  }
  return found;
}

mas_varset_class_t *
mas_varset_find_vclass( mas_varset_t * varset, const char *vclass_name )
{
  mas_varset_class_t *vclass = NULL;
  mas_varset_class_t *found = NULL;

  if ( varset )
  {
    mas_varset_class_t **pfound = NULL;

    vclass = mas_varset_vclass_create( vclass_name );
    if ( vclass )
    {
      pfound = tfind( vclass, &varset->classes, mas_varset_compare_vclass );
      if ( pfound )
        found = *pfound;
      mas_varset_vclass_delete( vclass );
    }
  }
  return found;
}

int
mas_varset_delete_vclass( mas_varset_t * varset, const char *vclass_name )
{
  mas_varset_class_t *vclass = NULL;
  mas_varset_class_t *found = NULL;

  if ( varset )
  {
    mas_varset_class_t **pfound = NULL;

    vclass = mas_varset_vclass_create( vclass_name );
    if ( vclass )
    {
      pfound = tfind( vclass, &varset->classes, mas_varset_compare_vclass );
      if ( pfound )
      {
        found = *pfound;
        tdelete( vclass, &varset->classes, mas_varset_compare_vclass );
        if ( found != vclass )
        {
          mas_varset_vclass_delete( found );
        }
      }
      mas_varset_vclass_delete( vclass );
      vclass = NULL;
    }
  }
  return found ? 1 : 0;
}

mas_var_t *
_mas_varset_vclass_find_variable( mas_varset_class_t * vclass, const char *name )
{
  mas_var_t *found = NULL;

  if ( vclass && vclass->vec )
  {
    for ( int i = 0; i < vclass->veccnt; i++ )
    {
      int len;
      int j;

      j = i * 2 + vclass->has_head;
      len = strlen( name );
      if ( vclass->vec[j].iov_len != len + 2 )
        continue;
      if ( 0 == memcmp( vclass->vec[j].iov_base, name, len ) )
      {
        found = &vclass->vec[j];
        break;
      }
    }
  }
  return found;
}

mas_var_t *
mas_varset_vclass_find_variable( mas_varset_class_t * vclass, const char *name )
{
  return _mas_varset_vclass_find_variable( vclass, name );
}

mas_var_t *
_mas_varset_vclass_search_variable( mas_varset_class_t * vclass, const char *name )
{
  mas_var_t *found = NULL;
  unsigned old_cnt = 0;
  unsigned new_cnt = 0;
  size_t new_size = 0;

  if ( vclass )
  {
    if ( vclass->vec )
      old_cnt = vclass->veccnt;
    new_cnt = old_cnt + 1;
    new_size = sizeof( mas_var_t ) * ( new_cnt * 2 + 1 + vclass->has_head );
    if ( old_cnt )
    {
      found = _mas_varset_vclass_find_variable( vclass, name );
      if ( !found )
        vclass->vec = mas_realloc( vclass->vec, new_size );
    }
    else
      vclass->vec = mas_malloc( new_size );
    if ( !found && vclass->vec )
    {
      found = &vclass->vec[old_cnt * 2 + vclass->has_head];
      memset( found, 0, sizeof( mas_var_t ) * 2 );
      found[2].iov_base = MAS_FINAL_STR;
      found[2].iov_len = MAS_FINAL_LEN;
      mas_varset_vclass_variable_set_name( found, name );
      vclass->veccnt += 1;
    }
  }
  return found;
}

mas_var_t *
__mas_varset_vclass_search_variable( mas_varset_class_t * vclass, const char *name )
{
  mas_var_t *found = NULL;

  if ( vclass )
  {
    if ( !vclass->vec )
    {
      vclass->vec = mas_malloc( sizeof( mas_var_t ) * ( 2 + 1 + vclass->has_head ) );
      found = &vclass->vec[0];
      memset( found, 0, sizeof( mas_var_t ) * ( 2 + 1 + vclass->has_head ) );
      /* found[0].iov_base = NULL; */
      /* found[0].iov_len = 0;     */
      found[2].iov_base = MAS_FINAL_STR;
      found[2].iov_len = MAS_FINAL_LEN;
      vclass->vec = found;
      vclass->veccnt = 1;
    }
    else
    {
      found = _mas_varset_vclass_find_variable( vclass, name );
      if ( !found )
      {
        int c, j;

        c = vclass->veccnt;
        j = c * 2;
        vclass->vec = mas_realloc( vclass->vec, sizeof( mas_var_t ) * ( j + 2 + 1 + vclass->has_head ) );
        found = &vclass->vec[j];
        memset( found, 0, sizeof( mas_var_t ) * ( 2 + 1 + vclass->has_head ) );
        found[2].iov_base = MAS_FINAL_STR;
        found[2].iov_len = MAS_FINAL_LEN;
        c++;
        vclass->veccnt = c;
      }
    }
  }
  if ( found && !mas_varset_vclass_variable_get_name_ref( found ) )
    mas_varset_vclass_variable_set_name( found, name );
  return found;
}

mas_varset_class_t *
mas_varset_vclass_search_variable( mas_varset_class_t * vclass, const char *vclass_name, const char *name, const char *value )
{
  mas_var_t *var = NULL;

  if ( !vclass )
  {
    vclass = mas_varset_vclass_create( vclass_name );
  }
  if ( vclass )
  {
    if ( name )
    {
      var = _mas_varset_vclass_search_variable( vclass, name );
      if ( var )
        mas_varset_vclass_variable_set_value( var, value );
    }
    else
    {
    }
    vclass->use_var = var;
  }
  return vclass;
}

mas_varset_class_t *
mas_varset_vclass_search_variable_va( mas_varset_class_t * vclass, const char *vclass_name, const char *name,
                                      mas_xvsnprintf_t func, const char *fmt, va_list args )
{
  char *text = NULL;
  size_t txsize = 1024 * 10;

  text = mas_malloc( txsize );
  if ( !func )
    func = mas_xvsnprintf;
  ( *func ) ( text, txsize, fmt, args );
  vclass = mas_varset_vclass_search_variable( vclass, vclass_name, name, text );
  mas_free( text );
  return vclass;
}

mas_varset_class_t *
mas_varset_vclass_search_variablef( mas_varset_class_t * vclass, const char *vclass_name, const char *name,
                                    mas_xvsnprintf_t func, const char *fmt, ... )
{
  va_list args;

  va_start( args, fmt );
  vclass = mas_varset_vclass_search_variable_va( vclass, vclass_name, name, func, fmt, args );
  va_end( args );
  return vclass;
}

const char *
mas_varset_vclass_variable_get_name_ref( mas_var_t * var )
{
  char *v = NULL;

  if ( var && var[0].iov_len )
    v = var[0].iov_base;
  return v;
}

char *
mas_varset_vclass_variable_get_name( mas_var_t * var )
{
  char *v = NULL;

  if ( var && var[0].iov_len )
  {
    v = mas_strndup( var[0].iov_base, var[0].iov_len - 2 );
  }
  return v;
}

const char *
mas_varset_vclass_variable_get_value_ref( mas_var_t * var )
{
  char *v = NULL;

  if ( var && var[1].iov_len )
  {
    v = var[1].iov_base;
  }
  return v;
}

char *
mas_varset_vclass_variable_get_value( mas_var_t * var )
{
  char *v = NULL;

  if ( var && var[1].iov_len )
    v = mas_strndup( var[1].iov_base, var[1].iov_len - 2 );
  return v;
}

void
mas_varset_vclass_variable_set_name( mas_var_t * var, const char *name )
{
  if ( var && name )
  {
    size_t l;
    char *s;

    if ( var[0].iov_base )
      mas_free( var[0].iov_base );
    var[0].iov_base = NULL;
    var[0].iov_len = 0;
    l = strlen( name );
    s = mas_strndup( name, l );
    s = mas_strcat_x( s, ": " );
    var[0].iov_len = l + 2;
    var[0].iov_base = s;
  }
}

void
mas_varset_vclass_variable_set_value( mas_var_t * var, const char *value )
{
  if ( var )
  {
    if ( var[1].iov_base )
      mas_free( var[1].iov_base );
    var[1].iov_base = NULL;
    var[1].iov_len = 0;
    if ( value )
    {
      size_t l;
      char *s;

      l = strlen( value );
      s = mas_strndup( value, l );
      s = mas_strcat_x( s, MAS_TAIL_STR );
      var[1].iov_len = l + MAS_TAIL_LEN;
      var[1].iov_base = s;
    }
  }
}
void
mas_varset_vclass_variable_set_value( mas_var_t * var, const char *value )
{
  if ( var )
  {
    if ( var[1].iov_base )
      mas_free( var[1].iov_base );
    var[1].iov_base = NULL;
    var[1].iov_len = 0;
    if ( value )
    {
      size_t l;
      char *s;

      l = strlen( value );
      s = mas_strndup( value, l );
      s = mas_strcat_x( s, MAS_TAIL_STR );
      var[1].iov_len = l + MAS_TAIL_LEN;
      var[1].iov_base = s;
    }
  }
}
void
mas_varset_vclass_variable_set_value_va( mas_var_t * var, mas_xvsnprintf_t func, const char *fmt, va_list args )
{
  char *text = NULL;
  size_t txsize = 1024 * 10;

  text = mas_malloc( txsize );
  if ( !func )
    func = mas_xvsnprintf;
  ( *func ) ( text, txsize, fmt, args );
  mas_varset_vclass_variable_set_value( var, text );
  mas_free( text );
}

void
mas_varset_vclass_variable_set_valuef( mas_var_t * var, mas_xvsnprintf_t func, const char *fmt, ... )
{
  va_list args;

  va_start( args, fmt );
  mas_varset_vclass_variable_set_value_va( var, func, fmt, args );
  va_end( args );
}

void
mas_varset_vclass_write( int fd, mas_varset_class_t * vclass )
{
  if ( fd > 0 && vclass )
    writev( fd, vclass->vec, vclass->veccnt * 2 + 1 );
}
